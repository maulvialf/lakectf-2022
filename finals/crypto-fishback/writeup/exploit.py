#!/usr/bin/env python3

from pwn import *

import pgpy

def start(*a, **kw):
    '''Start the exploit against the target.'''
    return remote('127.0.0.1', 1337)


io = start()

io.recvuntil(b'Your choice: ')
io.sendline(b'2')

pubkey = io.recvuntil(b'-----END PGP PUBLIC KEY BLOCK-----')
pubkey = pgpy.PGPKey.from_blob(pubkey)

io.recvuntil(b'Your choice: ')
io.sendline(b'1')

flag = io.recvuntil(b'-----END PGP MESSAGE-----')
flag = pgpy.PGPMessage.from_blob(flag)
flag_ct = bytes(flag.message.ct)

BLOCK_SIZE = 16
IVLEN = BLOCK_SIZE + 2
HEADERLEN = 4
MESSAGELEN = len(flag_ct) - IVLEN - HEADERLEN

flag.message.ct = bytearray(flag_ct)
for i in range(0, len(flag_ct), 32):
    for j in range(16):
        if not i and j < HEADERLEN: continue
        if IVLEN + i + j >= len(flag_ct): break
        flag.message.ct[IVLEN + i + j] ^= 1

io.recvuntil(b'Your choice: ')
io.sendline(b'3')

io.send(str(flag).encode())

reply = io.recvuntil(b'-----END PGP MESSAGE-----')
reply = pgpy.PGPMessage.from_blob(reply).message
reply = reply.partition('> ')[2].partition('\n\n')[0]
reply = reply.replace('�','?')
reply = bytes(b ^ 1 for b in reply.encode())
r1 = reply

flag.message.ct = bytearray(flag_ct)
for i in range(16, len(flag_ct), 32):
    for j in range(16):
        if IVLEN + i + j >= len(flag_ct): break
        flag.message.ct[IVLEN + i + j] ^= 1

io.recvuntil(b'Your choice: ')
io.sendline(b'3')

io.send(str(flag).encode())

reply = io.recvuntil(b'-----END PGP MESSAGE-----')
reply = pgpy.PGPMessage.from_blob(reply).message
reply = reply.partition('> ')[2].partition('\n\n')[0]
reply = reply.replace('�','?').replace('[REDACTED]', 'EPFL')
reply = bytes(b ^ 1 for b in reply.encode())
r2 = reply

res = r1[:8]
for i in range(8, max(len(r1), len(r2)) + 31, 32):
    res += r2[i:i+16]
    res += r1[i+16:i+32]
print(res.decode())

io.interactive()
