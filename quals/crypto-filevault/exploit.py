#!/usr/bin/env python3
from pwn import *
import sys

host = args.HOST or '127.0.0.1'
port = int(args.PORT or 4200)
if len(sys.argv) >= 3 and sys.argv[1] == "--connection-info":
    _, host, port = sys.argv[2].split()

io = connect(host, port)

io.sendlineafter(b"(list): ", b"list")
io.recvuntil(b"admin")
io.recv(5)
level3_hash = bytes.fromhex(io.recv(128).decode())

io.sendlineafter(b"(list): ", b"upload")
io.sendlineafter(b": ", b"0" * (65*2 + 1)) # odd number of hex to trigger exception and leak start of flag
io.recvuntil(b"file_hash = ")
line = io.recvline().strip().decode()
level4_hash = eval(line[:line.index('â€¦')] + "'")

BLOCK_SIZE = 8
collision = level4_hash[:BLOCK_SIZE * 2] + level3_hash[BLOCK_SIZE:]
io.sendlineafter(b"(list): ", b"upload")
io.sendlineafter(b": ", collision.hex().encode())

io.sendlineafter(b"(list): ", b"download")
io.sendlineafter(b": ", level3_hash.hex().encode())
flag = bytes.fromhex(io.recvline().decode())
with open('flag.png', 'rb') as f:
    expected_flag = f.read()

if flag == expected_flag:
    # Print flag for healthcheck
    print("EPFL{leaves!=branches}")
